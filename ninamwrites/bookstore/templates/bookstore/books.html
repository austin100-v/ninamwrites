{% extends 'bookstore/base.html' %}
{% load static %}

{% block title %}My Books{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'bookstore/css/books.css' %}">
<link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Open+Sans:wght@400;600&display=swap">
{% endblock %}

{% block content %}
<header>
    <div class="book-header">
        <h1>My Books</h1>
        <p>Explore my collection of books, each crafted with passion and creativity.</p>
    </div>
</header>

<section class="books">
    <h2>Featured Books</h2>
    <div class="book-list">
        {% for book in books %}
        <div class="book-item" data-book-id="{{ book.id }}">
            <img src="{{ book.image.url|default:'/static/bookstore/images/no-image.png' }}" alt="{{ book.title }}"
                onerror="this.src='{% static 'bookstore/images/no-image.png' %}'" loading="lazy">
            <h3>{{ book.title }}</h3>
            <p class="book-author">{{ book.author }}</p>
            <p class="book-date">
                <time datetime="{{ book.published_date|date:'Y-m-d' }}">
                    {{ book.published_date|date:"M Y" }}
                </time>
            </p>
            <p class="book-price">${{ book.price|floatformat:2 }}</p>

            <div class="book-actions">
                <button class="btn-details"
                    data-image="{{ book.image.url|default:'/static/bookstore/images/no-image.png' }}"
                    data-title="{{ book.title|escapejs }}" data-author="{{ book.author|escapejs }}"
                    data-description="{{ book.description|escapejs }}" data-price="{{ book.price|floatformat:2 }}"
                    data-published="{{ book.published_date|date:'M Y' }}">
                    View Details
                </button>

                <button class="btn-add-cart" data-book-id="{{ book.id }}" data-title="{{ book.title|escapejs }}">
                    <span class="btn-text">Add to Cart</span>
                    <div class="loading-spinner"></div>
                </button>
            </div>
        </div>
        {% empty %}
        <div class="no-books">
            <p>No books available at the moment.</p>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Improved Modal with Accessibility -->
<div id="book-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-describedby="modal-description"
    aria-hidden="true" style="display:none;">
    <div class="modal-content" role="document">
        <button class="close-btn" aria-label="Close modal" title="Close">&times;</button>

        <div class="modal-body">
            <img id="modal-image" src="" alt="" style="max-width:200px; height:auto; margin-bottom: 15px;">

            <h3 id="modal-title"></h3>
            <p class="modal-author" id="modal-author"></p>
            <p class="modal-published" id="modal-published"></p>
            <p class="modal-price" id="modal-price" style="font-weight: bold; color: #2c3e50;"></p>
            <p id="modal-description"></p>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn-add-cart-modal" id="modal-add-cart">
                    <span class="btn-text">Add to Cart</span>
                    <div class="loading-spinner"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<script>
    class BookStore {
        constructor() {
            this.modal = document.getElementById('book-modal');
            this.currentBookId = null;
            this.init();
        }

        init() {
            this.attachEventListeners();
            this.addKeyboardNavigation();
        }

        attachEventListeners() {
            // View Details buttons
            document.querySelectorAll('.btn-details').forEach(btn => {
                btn.addEventListener('click', (e) => this.showDetails(e.target));
            });

            // Add to Cart buttons (main list)
            document.querySelectorAll('.btn-add-cart').forEach(btn => {
                btn.addEventListener('click', (e) => this.addToCart(e.target));
            });

            // Modal close button
            const closeBtn = document.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => this.closeModal());
            }

            // Modal background click to close
            this.modal.addEventListener('click', (e) => {
                if (e.target === this.modal) {
                    this.closeModal();
                }
            });

            // Modal Add to Cart button
            const modalAddBtn = document.getElementById('modal-add-cart');
            if (modalAddBtn) {
                modalAddBtn.addEventListener('click', () => {
                    if (this.currentBookId) {
                        this.addToCart(modalAddBtn, this.currentBookId);
                    }
                });
            }
        }

        addKeyboardNavigation() {
            // Escape key to close modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.modal.style.display === 'flex') {
                    this.closeModal();
                }
            });

            // Tab trapping in modal
            this.modal.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    this.trapFocus(e);
                }
            });
        }

        trapFocus(e) {
            const focusableElements = this.modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if (e.shiftKey) {
                if (document.activeElement === firstElement) {
                    lastElement.focus();
                    e.preventDefault();
                }
            } else {
                if (document.activeElement === lastElement) {
                    firstElement.focus();
                    e.preventDefault();
                }
            }
        }

        showDetails(button) {
            try {
                // Get data from button attributes
                const imageUrl = button.dataset.image || '';
                const title = button.dataset.title || '';
                const author = button.dataset.author || '';
                const description = button.dataset.description || '';
                const price = button.dataset.price || '';
                const published = button.dataset.published || '';

                // Get book ID from parent element
                const bookItem = button.closest('.book-item');
                this.currentBookId = bookItem ? bookItem.dataset.bookId : null;

                // Update modal content
                document.getElementById('modal-image').src = imageUrl;
                document.getElementById('modal-image').alt = title;
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-author').textContent = `by ${author}`;
                document.getElementById('modal-published').textContent = `Published: ${published}`;
                document.getElementById('modal-price').textContent = `$${price}`;
                document.getElementById('modal-description').textContent = description;

                // Update modal Add to Cart button
                const modalAddBtn = document.getElementById('modal-add-cart');
                if (modalAddBtn && this.currentBookId) {
                    modalAddBtn.dataset.bookId = this.currentBookId;
                    modalAddBtn.dataset.title = title;
                }

                // Show modal
                this.modal.style.display = 'flex';
                this.modal.setAttribute('aria-hidden', 'false');

                // Focus on close button for accessibility
                const closeBtn = this.modal.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.focus();
                }

            } catch (error) {
                console.error('Error showing book details:', error);
                this.showMessage('Error loading book details', 'error');
            }
        }

        closeModal() {
            this.modal.style.display = 'none';
            this.modal.setAttribute('aria-hidden', 'true');
            this.currentBookId = null;
        }

        async addToCart(button, bookId = null) {
            try {
                // Get book ID and title
                const id = bookId || button.dataset.bookId;
                const title = button.dataset.title || 'Book';

                if (!id) {
                    throw new Error('Book ID not found');
                }

                // Show loading state
                this.setLoadingState(button, true);

                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

                if (!csrfToken) {
                    throw new Error('CSRF token not found');
                }

                // Make AJAX request to add to cart
                const response = await fetch('/add-to-cart/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        book_id: id,
                        quantity: 1
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    this.showMessage(`"${title}" added to cart!`, 'success');
                    // Update cart count if you have one
                    this.updateCartCount(data.cart_count);
                } else {
                    throw new Error(data.message || 'Failed to add to cart');
                }

            } catch (error) {
                console.error('Error adding to cart:', error);
                this.showMessage(error.message || 'Failed to add to cart', 'error');
            } finally {
                // Remove loading state
                this.setLoadingState(button, false);
            }
        }

        setLoadingState(button, loading) {
            const spinner = button.querySelector('.loading-spinner');
            const text = button.querySelector('.btn-text');

            if (loading) {
                button.classList.add('btn-disabled');
                button.disabled = true;
                if (spinner) spinner.style.display = 'block';
                if (text) text.style.display = 'none';
            } else {
                button.classList.remove('btn-disabled');
                button.disabled = false;
                if (spinner) spinner.style.display = 'none';
                if (text) text.style.display = 'inline';
            }
        }

        showMessage(message, type = 'success') {
            // Remove existing messages
            document.querySelectorAll('.success-message, .error-message').forEach(el => el.remove());

            // Create message element
            const messageEl = document.createElement('div');
            messageEl.className = type === 'success' ? 'success-message' : 'error-message';
            messageEl.textContent = message;
            messageEl.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';

            document.body.appendChild(messageEl);

            // Auto remove after 3 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 3000);
        }

        updateCartCount(count) {
            // Update cart count in navigation if you have one
            const cartCountEl = document.querySelector('.cart-count');
            if (cartCountEl) {
                cartCountEl.textContent = count;
            }
        }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        new BookStore();
    });

    // Legacy functions for backward compatibility (if needed)
    function showDetails(imageUrl, title, description) {
        console.warn('showDetails() is deprecated. Please use the new BookStore class.');
    }

    function closeModal() {
        console.warn('closeModal() is deprecated. Please use the new BookStore class.');
    }
</script>
{% endblock %}