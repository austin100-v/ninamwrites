{% extends "ninamwrites_admin/base.html" %}
{% load static %}

{% block title %}{% if is_edit %}Edit Book{% else %}Manage Books{% endif %}{% endblock %}

{% block extrahead %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .form-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-top: 1rem;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        border-radius: 10px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .nav-tabs {
        border: none;
        margin-bottom: 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        background: #f8f9fa;
        color: #6c757d;
        margin-right: 0.5rem;
        border-radius: 10px 10px 0 0;
        font-weight: 500;
        padding: 1rem 1.5rem;
    }
    
    .nav-tabs .nav-link.active {
        background: white;
        color: #495057;
        border-bottom: 3px solid #007bff;
    }
    
    .btn-action {
        margin: 0 2px;
    }
    
    .table th {
        background: #f8f9fa;
        border: none;
        font-weight: 600;
        color: #495057;
        padding: 1rem 0.75rem;
    }
    
    .table td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        border-color: #f8f9fa;
    }
    
    .image-preview {
        max-width: 50px;
        max-height: 50px;
        border-radius: 5px;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .success-message, .error-message {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="mb-2">
            <i class="bi bi-book"></i>
            {% if is_edit %}Edit Book{% else %}Book Management{% endif %}
        </h1>
        <p class="mb-0">Manage your book inventory efficiently</p>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="bookTabs">
        <li class="nav-item">
            <a class="nav-link {% if not is_edit %}active{% endif %}" data-tab="manage-books" href="javascript:void(0)">
                <i class="bi bi-list-ul"></i> Manage Books
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if is_edit %}active{% endif %}" data-tab="add-book" href="javascript:void(0)">
                <i class="bi bi-plus-circle"></i> 
                {% if is_edit %}Edit Book{% else %}Add Book{% endif %}
            </a>
        </li>
    </ul>

    <!-- Manage Books Table -->
    <div class="tab-content {% if not is_edit %}active{% endif %}" id="manage-books">
        <div class="table-container">
            {% if books %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="bi bi-table"></i> Book Inventory</h4>
                    <span class="badge bg-primary">{{ books|length }} Book{{ books|length|pluralize }}</span>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th><i class="bi bi-hash"></i> ID</th>
                                <th><i class="bi bi-book"></i> Title</th>
                                <th><i class="bi bi-person"></i> Author</th>
                                <th><i class="bi bi-currency-dollar"></i> Price</th>
                                <th><i class="bi bi-barcode"></i> ISBN</th>
                                <th><i class="bi bi-boxes"></i> Stock</th>
                                <th><i class="bi bi-image"></i> Cover</th>
                                <th><i class="bi bi-gear"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody id="books-list">
                            {% for book in books %}
                            <tr id="book-{{ book.pk }}" data-id="{{ book.pk }}">
                                <td><span class="badge bg-secondary">{{ book.pk }}</span></td>
                                <td>
                                    <strong>{{ book.title }}</strong>
                                    {% if book.description %}
                                        <br><small class="text-muted">{{ book.description|truncatechars:50 }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ book.author }}</td>
                                <td><span class="badge bg-success">${{ book.price }}</span></td>
                                <td>{{ book.isbn|default:"â€”" }}</td>
                                <td>
                                    <span class="badge {% if book.stock_quantity > 0 %}bg-info{% else %}bg-warning{% endif %}">
                                        {{ book.stock_quantity }}
                                    </span>
                                </td>
                                <td>
                                    {% if book.image %}
                                        <img src="{{ book.image.url }}" class="image-preview" alt="Book cover">
                                    {% else %}
                                        <i class="bi bi-image text-muted"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'ninamwrites_admin:edit_book' book.pk %}" 
                                           class="btn btn-sm btn-outline-primary btn-action"
                                           title="Edit Book">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger btn-action delete-book-btn" 
                                                data-book-id="{{ book.pk }}"
                                                data-book-title="{{ book.title }}"
                                                title="Delete Book">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-book"></i>
                    <h4>No Books Found</h4>
                    <p>Start building your library by adding your first book.</p>
                    <button class="btn btn-primary" onclick="document.querySelector('[data-tab=add-book]').click()">
                        <i class="bi bi-plus-circle"></i> Add Your First Book
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Add/Edit Book Form -->
    <div class="tab-content {% if is_edit %}active{% endif %}" id="add-book">
        <div class="form-container">
            <div class="row">
                <div class="col-md-8 mx-auto">
                    <h4 class="mb-4">
                        <i class="bi bi-{% if is_edit %}pencil{% else %}plus-circle{% endif %}"></i>
                        {% if is_edit %}Edit Book{% else %}Add New Book{% endif %}
                    </h4>
                    
                    <form id="book-form" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-book"></i> Title *</label>
                                    <input type="text" name="title" class="form-control" 
                                           value="{{ book.title|default_if_none:'' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-person"></i> Author *</label>
                                    <input type="text" name="author" class="form-control" 
                                           value="{{ book.author|default_if_none:'' }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-card-text"></i> Description</label>
                            <textarea name="description" class="form-control" rows="3" 
                                      placeholder="Enter book description...">{{ book.description|default_if_none:'' }}</textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-currency-dollar"></i> Price *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" step="0.01" min="0" name="price" class="form-control" 
                                               value="{{ book.price|default_if_none:'' }}" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-boxes"></i> Stock Quantity *</label>
                                    <input type="number" min="0" name="stock_quantity" class="form-control" 
                                           value="{{ book.stock_quantity|default_if_none:'0' }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-calendar"></i> Published Date</label>
                                    <input type="date" name="published_date" class="form-control" 
                                           value="{% if book.published_date %}{{ book.published_date|date:'Y-m-d' }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-barcode"></i> ISBN</label>
                                    <input type="text" name="isbn" class="form-control" 
                                           placeholder="978-0-123456-47-2"
                                           value="{{ book.isbn|default_if_none:'' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-image"></i> Book Cover 
                                {% if not book %}*{% endif %}
                            </label>
                            <input type="file" name="image" class="form-control" accept="image/*" 
                                   {% if not book %}required{% endif %}>
                            {% if book.image %}
                                <div class="mt-2">
                                    <small class="text-muted">Current cover:</small><br>
                                    <img src="{{ book.image.url }}" class="img-thumbnail" style="max-width: 150px;">
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary me-md-2" 
                                    onclick="document.querySelector('[data-tab=manage-books]').click()">
                                <i class="bi bi-arrow-left"></i> Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <i class="bi bi-{% if is_edit %}check-circle{% else %}plus-circle{% endif %}"></i>
                                <span class="btn-text">
                                    {% if is_edit %}Update Book{% else %}Add Book{% endif %}
                                </span>
                                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<strong id="deleteBookTitle"></strong>"?</p>
                <p class="text-muted mb-0">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash"></i> Delete Book
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabs = document.querySelectorAll('.nav-link[data-tab]');
    const panels = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active classes
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));
            
            // Add active classes
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    // Form submission with AJAX
    const bookForm = document.getElementById('book-form');
    const submitBtn = document.getElementById('submit-btn');
    const isEdit = {{ is_edit|yesno:"true,false" }};
    
    if (bookForm) {
        bookForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(bookForm);
            const submitUrl = isEdit ? 
                `/ninamwrites_admin/books/edit/{% if book %}{{ book.pk }}{% endif %}/` : 
                `/ninamwrites_admin/books/`;
            
            // Show loading state
            setLoadingState(submitBtn, true);
            
            fetch(submitUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                setLoadingState(submitBtn, false);
                
                if (data.success) {
                    showMessage(
                        isEdit ? 'Book updated successfully!' : 'Book added successfully!', 
                        'success'
                    );
                    
                    if (!isEdit) {
                        // Add new book to table or replace empty state
                        addBookToTable(data.book);
                        bookForm.reset();
                    } else {
                        // Update existing book row
                        updateBookRow(data.book);
                    }
                    
                    // Switch to manage books tab
                    document.querySelector('[data-tab="manage-books"]').click();
                } else {
                    showMessage(data.error || 'An error occurred', 'error');
                }
            })
            .catch(error => {
                setLoadingState(submitBtn, false);
                console.error('Error:', error);
                showMessage('Network error. Please try again.', 'error');
            });
        });
    }

    // Delete functionality
    let bookIdToDelete = null;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const deleteBookTitle = document.getElementById('deleteBookTitle');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    // Delete button event listeners
    document.querySelectorAll('.delete-book-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            bookIdToDelete = this.dataset.bookId;
            deleteBookTitle.textContent = this.dataset.bookTitle;
            deleteModal.show();
        });
    });
    
    // Confirm delete
    confirmDeleteBtn.addEventListener('click', function() {
        if (!bookIdToDelete) return;
        
        setLoadingState(confirmDeleteBtn, true);
        
        fetch(`/ninamwrites_admin/books/delete/${bookIdToDelete}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            setLoadingState(confirmDeleteBtn, false);
            deleteModal.hide();
            
            if (data.success) {
                // Remove book row with animation
                const bookRow = document.getElementById(`book-${bookIdToDelete}`);
                if (bookRow) {
                    bookRow.style.transition = 'opacity 0.3s';
                    bookRow.style.opacity = '0';
                    setTimeout(() => {
                        bookRow.remove();
                        checkEmptyState();
                    }, 300);
                }
                showMessage(data.message || 'Book deleted successfully!', 'success');
            } else {
                showMessage(data.error || 'Error deleting book', 'error');
            }
        })
        .catch(error => {
            setLoadingState(confirmDeleteBtn, false);
            deleteModal.hide();
            console.error('Error:', error);
            showMessage('Network error. Please try again.', 'error');
        });
        
        bookIdToDelete = null;
    });

    // Utility functions
    function setLoadingState(button, loading) {
        const spinner = button.querySelector('.spinner-border');
        const text = button.querySelector('.btn-text') || button;
        
        if (loading) {
            button.disabled = true;
            if (spinner) spinner.classList.remove('d-none');
            button.classList.add('loading');
        } else {
            button.disabled = false;
            if (spinner) spinner.classList.add('d-none');
            button.classList.remove('loading');
        }
    }
    
    function showMessage(message, type) {
        // Remove existing messages
        document.querySelectorAll('.success-message, .error-message').forEach(el => el.remove());
        
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const iconClass = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle';
        
        const messageEl = document.createElement('div');
        messageEl.className = `alert ${alertClass} alert-dismissible fade show ${type}-message`;
        messageEl.innerHTML = `
            <i class="bi ${iconClass}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(messageEl);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.remove();
            }
        }, 5000);
    }
    
    function addBookToTable(book) {
        let booksList = document.getElementById('books-list');
        
        // If there's an empty state, replace it with table
        const emptyState = document.querySelector('.empty-state');
        if (emptyState) {
            location.reload(); // Reload to show proper table structure
            return;
        }
        
        if (booksList) {
            const newRow = document.createElement('tr');
            newRow.id = `book-${book.id}`;
            newRow.dataset.id = book.id;
            newRow.innerHTML = `
                <td><span class="badge bg-secondary">${book.id}</span></td>
                <td><strong>${book.title}</strong></td>
                <td>${book.author}</td>
                <td><span class="badge bg-success">$${book.price}</span></td>
                <td>${book.isbn || 'â€”'}</td>
                <td><span class="badge bg-info">0</span></td>
                <td><i class="bi bi-image text-muted"></i></td>
                <td>
                    <div class="btn-group" role="group">
                        <a href="${book.edit_url}" class="btn btn-sm btn-outline-primary btn-action" title="Edit Book">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-danger btn-action delete-book-btn" 
                                data-book-id="${book.id}" data-book-title="${book.title}" title="Delete Book">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            booksList.appendChild(newRow);
            
            // Add event listener to new delete button
            const newDeleteBtn = newRow.querySelector('.delete-book-btn');
            newDeleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                bookIdToDelete = this.dataset.bookId;
                deleteBookTitle.textContent = this.dataset.bookTitle;
                deleteModal.show();
            });
        }
    }
    
    function updateBookRow(book) {
        const bookRow = document.getElementById(`book-{% if book %}{{ book.pk }}{% endif %}`);
        if (bookRow) {
            // Update the row content (simplified for this example)
            location.reload(); // Reload to show updated data
        }
    }
    
    function checkEmptyState() {
        const booksList = document.getElementById('books-list');
        if (booksList && booksList.children.length === 0) {
            location.reload(); // Reload to show empty state
        }
    }
});
</script>
{% endblock %}